# HexaFloorRide Hardware

This page lists all the parts that you need in order to build your own HexaFloorRide. 

## Chassis

HexaFloorRide's chassis is comprised of a lower main body section with six protruding legs with 3 axis of movement. The body and legs are milled out of 6061 extruded aluminium. When fully assembed HexaFloorRide's physical dimensions are roughly:

* Height = ~ 7.5 inches when in neutral standing position.
* Length = ~ 15.5 inches when in neutral standing position.
* Weight = ~ 4.1 lbs (1856g) without battery or PCB.

HexaFloorRide's chassis is comprised of:
* 1 lower body panel
* 1 mounting post with #2-56 threaded holes on all 4 sides for mounting things
* 2 mounting brackets
* 1 battery holder
* 1 battery
* 18 servo motors
* 6 thigh components
* 6 ServoBlock assembles (for the hips)
* 6 shin components
* 6 foot components
* 6 shoe components

<table>
   <caption>HexaFloorRide Components</caption>
   <tr>
      <th>Qty</th>
      <th>Name</th>
      <th>Image</th>
   </tr>  
   <tr>
      <td align ="left"> 
         1
      </td>
      <td align ="left"> 
         Lower body<br>
         Weight 141g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrChassis.png" alt="Lower body" width="100" height="100">
            <figcaption>Fig.1 - Lower body</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         6
      </td>
      <td align ="left"> 
         Thigh<br>
         Weight 7g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrThigh.png" alt="Hip" width="100" height="100">
            <figcaption>Fig.2 - Thigh</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         6
      </td>
      <td align ="left"> 
         Shin<br>
         Weight 13g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrShin.png" alt="Shin" width="100" height="100">
            <figcaption>Fig.3 - Shin</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         6
      </td>
      <td align ="left"> 
         Foot<br>
         Weight 12g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrFoot.png" alt="Foot" width="100" height="100">
            <figcaption>Fig.4 - Foot</figcaption>
         </figure> 
      </td>
   </tr>
  <tr>
      <td align ="left"> 
         6
      </td>
      <td align ="left"> 
         Shoe
         Weight <0.16g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrShoe.png" alt="Foot" width="100" height="100">
            <figcaption>Fig.5 - Shoe</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         1
      </td>
      <td align ="left"> 
         Mounting Post<br>
         Weight 133g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrMountingPost.png" alt="Mounting Post" width="100" height="100">
            <figcaption>Fig.6 - Mounting Post</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         2
      </td>
      <td align ="left"> 
         Mounting Bracket<br>
         Weight included in Mounting Post
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrMountingBracket.png" alt="Mounting Bracket" width="100" height="100">
            <figcaption>Fig.7 - Mounting Bracket</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         1
      </td>
      <td align ="left"> 
         Battery Holder<br>
         Weight 73g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrBatteryHolder.png" alt="Battery Holder" width="100" height="100">
            <figcaption>Fig.8 - Battery Holder</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         1
      </td>
      <td align ="left"> 
         Battery<br>
         Weight 542g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrBattery.png" alt="Battery" width="100" height="100">
            <figcaption>Fig.9 - Battery</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         18
      </td>
      <td align ="left"> 
         Servo motor<br>
         Weight 43g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrServoMotor.png" alt="Battery" width="100" height="100">
            <figcaption>Fig.10 - Servo Motor</figcaption>
         </figure> 
      </td>
   </tr>
   <tr>
      <td align ="left"> 
         18
      </td>
      <td align ="left"> 
         Servo Block<br>
         <a href="https://www.servocity.com/servoblock-standard-size-24-tooth-spline-hub-shaft/">24T Spline horn & block</a><br>
         49g
      </td>
      <td align ="left"> 
         <figure>
            <img src="/physicalDesign/fusionExports/hfrServoBlock.png" alt="Battery" width="100" height="100">
            <figcaption>Fig.11 - Servo Block</figcaption>
         </figure> 
      </td>
   </tr>
</table>  

## Miscellaneous Hardware

In addition to the parts above you will also need 

* 120 [#2-56 x 3/8" cap head screws](https://www.amazon.ca/gp/product/B073W96K9C/ref=ppx_yo_dt_b_asin_title_o07_s00?ie=UTF8&psc=1)
* 48 [M4-0.7 x 12mm socket head cap screws](https://www.amazon.ca/dp/B07CJ7PTRS?psc=1&ref=ppx_yo2ov_dt_b_product_details)
* 12 M4-07 x 8mm socket head cap screws (come with ServoBlock kit from ServoCity)
 
## Servo Motors & Horns 

<table>
  <tr>
    <td align ="left"> 
       <figure>
          <img src="/img/hs485hbServoMotorsAndHorns.jpg" alt="servo motor" width="100" height="100">
          <figcaption>Fig.5 - Servo motor</figcaption>
       </figure> 
    </td>
    <td align ="left"> 
       HexaFloorRide has a total of 18 leg joints. Each leg has a hip, knee and ankle joint. These joints are 
       <a href="https://www.robotshop.com/ca/en/combo-pack-6x-hs-485hb-free-metal-servo-horns.html">HiTec HS-485HB servo motors</a> which we purchased from the Robot Shop. The motors came in a bundle with aluminium 24T horns that fit the servo shafts. The applied voltage of this motor should be in range of 4.8 to 7.2V. The frequency of motor is 50 Hz and the PWM duty cycle is 20 milliseconds. This motor has 3 pins as follows:
      <ul>
         <li>PWM: Orange</li>
         <li>VCC: Red</li>
         <li>GND: Brown</li>
      </ul>
    </td>   
  </tr>
</table>  

## Motor Drivers

<table>
  <tr>
    <td align ="left"> 
       <figure>
          <img src="/img/pca9685-16-channel-12-bit-pwm-servo-driver_1.jpg" alt="motor driver" width="100" height="100">
          <figcaption>Fig.7 - Motor driver</figcaption>
       </figure> 
    </td>
    <td align ="left"> 
       The Hexpod robot requires a way to connect a large number of servo motors to a microcontroller with limit IO pins. To achieve this we use a pair of Adafruit <a href="https://cdn-learn.adafruit.com/downloads/pdf/16-channel-pwm-servo-driver.pdf">PCA9685 16-channel 12-bit servo motor drivers</a>. These motor drivers have their own onboard NXP Semiconductors <a href="http://www.adafruit.com/datasheets/PCA9685.pdf">PCA9685 microcontrollers</a> that handles the details of PWM signalling to the motors so all we have to do is communicate to them via I2C which only consumes 2 IO pins. The defult I2C address for the driver is 64 (0x40). There is also an all-call address at 112 (0x70). Since HexaFloorRide has 18 motors and a single driver can only handle a maximum of 16 we need to use 2 of these drivers. Since both drivers are on the same I2C bus we need to change the I2C address of the second driver to avoid conflicts. Page 13 of the Adafruit document explains how to do this. In short, we solder A0 port on the left controller to change it's address to 0x41. 

The motor controller has specific behavours. We tested these behaviours and found the following:
       
### Test 1: Fresh start
      
Steps:
* Power up 3.3VDC
* Power up 5.0 VDC
* Pull USB cable off ESP32
* No MQTT motor commands issued
      
This resulted in all servos being compliant with no resistance to moving them.

### Test 2: From fresh start issue command to one servo

Steps:
* Issue command stp,0,0,300

This resulted in the servo no longer being compliant. It now tries to hold its position

### Test 3: Cut power to see if robot goes back to being compliant

1. Cut 3.3VDC power. Servo becomes compliant.
2. Add 3.3vdc power back. Servo goes back to last position and is no longer compliant.
3. Cut 5VDC power. Servo becomes compliant.
4. Add 5vdc power back. Servo goes back to last position and is no longer compliant.
5. Disconnect USB cable from SOC. Servo becomes compliant.
6. Reconnect USB cable to SOC. Requirs yu to re-establish console connectin in but does not require a reload of the software. Servo remains compliant.

Based on this testing it appears that the only way to erase past motor commends is to disconnect the console cable from the SOC. Not entirely sure what this means. Is the SOC sending continual messages to the PCA9685 via the library we are using? Cannot think what other explanation there is for this behaviour. Need to break out a scope or protocol analyzer to check on this. Will be very surprised if this is the case.  
    </td>   
  </tr>
</table>  

## Line level converter

<table>
  <tr>
    <td align ="left"> 
       <figure>
          <img src="/img/voltageLevelConverter.jpg" alt="motor driver" width="100" height="100">
          <figcaption>Fig.8 - I2C bus voltage converter</figcaption>
       </figure> 
    </td>
    <td align ="left"> 
       Since the ESP32 microprocessor used for HexaFloorRide's brain is a 3.3VDC device and the PCA9685 microprocessor used in the motor driver board is a 5 VDC device we must use a line level converter on the I2C bus to connect between them. HexaFloorRide uses the KeeYees <a href="https://www.amazon.ca/gp/product/B07LG646VS/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1">4 Channel I2C Logic Level Converter Bi-Directional Module</a> which appears to be a clone of the Sparkfun Bi-Directional Logic Level Converter. For wiring help check out the <a href="https://learn.sparkfun.com/tutorials/bi-directional-logic-level-converter-hookup-guide/all">wiring guide</a>. 
    </td>   
  </tr>
</table>  

## Main processor

<table>
  <tr>
    <td align ="left"> 
       <figure>
          <img src="/img/huzzah32.jpg" alt="ESP32 dev board" width="100" height="100">
          <figcaption>Fig.9 - ESP32 Dev Board</figcaption>
       </figure> 
    </td>
    <td align ="left"> 
       The brains of HexaFloorRide come courtesy of an Espressif <a href="https://va3wam.github.io/soc/technology%20stack/architecture/SOC-Technology-Stack/">ESP32</a> Software On a Chip (SOC). We are using Adafruit 28 pin variant of their <a href="https://www.adafruit.com/product/3619">Huzzah32 Feather</a> development board for ESP32 integration into our circuit.  
    </td>   
  </tr>
</table>  

## Motion Sensors

```Not sure if we will use this or not```

The robotâ€™s motion tracking is provided by an Invensense MPU6050 inertial measurement unit development board which combine a 3-axis 
microelectromechanical gyroscope and a 3-axis accelerometer on the same silicon die, together with an onboard Digital Motion Processor (DMP), which processes complex 6-axis MotionFusion algorithms. 

## Power Management

The robot is powered by direct current provided by a Dewalt 20V 3AH lithium-ion battery. This voltage is stepped down to a 12 volt bus, a 5 
volt bus and a 3.3 volt bus using a Drok LM2596 multiple output power supply.  

## Buttons

The robot features a [reset and selection button](https://www.adafruit.com/product/3350) as well as a [power button](https://www.adafruit.com/product/4659). These buttons feature embedded software controlled LEDs that allow for the robot to give visual queues as to what it is doing.

## OLED/LCD

```Not sure what display we will use yet```.

## Assembly
Full step by step instructions for HexaFloorRide can be found [here](/docs/hexaFloorRideAssembly.md).
